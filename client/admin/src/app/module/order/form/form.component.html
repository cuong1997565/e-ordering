<ele-breadcrumb [items]="['Order'|trans, (fd.isNew?'Detail':'Detail')|trans]" icon="copy"></ele-breadcrumb>

<div id="content">
    <div class="row">
        <form [formGroup]="fd.form" class="form-horizontal" (ngSubmit)="save()">
            <div class="col-md-12">
                <div class="jarviswidget">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-pencil-square-o"></i> </span>
                        <h2>{{'Order Detail' |trans}}</h2>
                    </header>
                    <div class="widget-body">
                        <div class="row flowBox">
                            <div id="order-if" class="col-md-6 order-6 ">

                                <legend>{{'Order Info'|trans}}</legend>

                                <div id="info-form">
                                    <fieldset *ngIf="ld">
                                        <div class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Status:'|trans}}</label>
                                            <div *ngIf="ld.status === app.constant.WAITING_FOR_CONFIRM" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Waiting for confirm'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.REVIEWING" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Reviewing'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.CLOSED" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'CLOSED'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.REJECTED_BY_SALES" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Rejected by Sales'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.CANCELLED_BY_CUSTOMER" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Cancelled'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.SALES_ACCEPTED" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Sales Approved (Locked)'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.DELIVERING" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Delivering'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === app.constant.SUBMITED" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{'Submited'}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === 9" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{''}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === 0" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{''}}"
                                                       autocomplete="off">
                                            </div>
                                            <div *ngIf="ld.status === null" class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Status'|trans}}"
                                                       class="form-control" disabled value="{{''}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Factory:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Factory'|trans}}"
                                                       class="form-control" disabled value="{{ld.factory?ld.factory.name:''}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Order Date:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Order Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.created_at}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Update Date:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Update Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.updated_at}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Delivery Date:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Delivery Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.deliver_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.processing_date" class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Reviewing Date:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Reviewing Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.processing_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.confirm_date" class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Edit Date:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Edit Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.confirm_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.approved_date" class="info-div">
                                            <label class="col-lg-12 col-md-12 control-label">{{'Approved Date:'|trans}}</label>
                                            <div class="col-lg-12 col-md-12">
                                                <input type="text" placeholder="{{'Approved Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.approved_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.po_number" class="info-div">
                                            <label class="col-lg-12 col-md-12 col-sm-12 col-xs-12 control-label"> {{ 'PO Number :' | trans }} </label>
                                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                                <input type="text" placeholder="{{'Po Number'|trans}}"
                                                class="form-control" disabled value="{{ld.po_number}}">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.type" class="info-div">
                                            <label class="col-lg-12 col-md-12 col-sm-12 col-xs-12 control-label"> {{ 'Type:' | trans }} </label>
                                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                                                <input type="text" *ngIf="app.constant.Type_Order_Manual == ld.type" placeholder="{{'Po Type'|trans}}"
                                                       class="form-control" disabled value="{{'Manual' | trans}}">
                                                <input type="text" *ngIf="app.constant.Type_Order_Auto == ld.type" placeholder="{{'Po Type'|trans}}"
                                                       class="form-control" disabled value="{{'Auto' | trans}}">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.rejected_date" class="info-div">
                                            <label class="col-md-12 control-label">{{'Reject Date:'|trans}}</label>
                                            <div class="col-md-12">
                                                <input type="text" placeholder="{{'Reject Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.rejected_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.canceled_date" class="info-div">
                                            <label class="col-md-12 control-label">{{'Cancelled Date:'|trans}}</label>
                                            <div class="col-md-12">
                                                <input type="text" placeholder="{{'Cancelled Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.canceled_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>
                                        <div *ngIf="ld.completed_date" class="info-div">
                                            <label class="col-md-12 control-label">{{'Completed Date:'|trans}}</label>
                                            <div class="col-md-12">
                                                <input type="text" placeholder="{{'Completed Date'|trans}}"
                                                       class="form-control" disabled value="{{ld.completed_date}}"
                                                       autocomplete="off">
                                            </div>
                                        </div>

                                    </fieldset>
                                </div>
                            </div>

                            <div class="col-md-6 order-6 ">
                                <legend>{{'Customer Info'|trans}}</legend>
                                <fieldset *ngIf="ld">
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Name:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <input type="text" placeholder="{{'Name'|trans}}"
                                                   class="form-control" disabled value="{{ld.customer?ld.customer.name:''}}"
                                                   autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Email:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <input type="text" placeholder="{{'Email'|trans}}"
                                                   class="form-control" disabled value="{{ld.customer?ld.customer.email:''}}"
                                                   autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Phone:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <input type="text" placeholder="{{'Phone'|trans}}"
                                                   class="form-control" disabled
                                                   value="{{ld.distributor?ld.distributor.phone:''}}"
                                                   autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Distributor:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <input type="text" placeholder="{{'Distributor'|trans}}"
                                                   class="form-control" disabled
                                                   value="{{ld.distributor?ld.distributor.name:''}}"
                                                   autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Province:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <input type="text" placeholder="{{'Province'|trans}}"
                                                   class="form-control" disabled
                                                   value="{{ld.distributor?ld.distributor.area.name:''}}"
                                                   autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Address:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <input type="text" placeholder="{{'Address'|trans}}"
                                                   class="form-control" disabled
                                                   value="{{ld.deliver_address !== null ? ld.deliver_address : ld.distributor?ld.distributor.address:''}}"
                                                   autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="info-div">
                                        <label class="col-lg-12 col-md-12 control-label">{{'Customer Note:'|trans}}</label>
                                        <div class="col-lg-12 col-md-12">
                                            <textarea value="{{ld.creator_note}}" disabled rows="5" cols="69"></textarea>
                                        </div>
                                    </div>
                                    <div *ngIf="ld.processing_date" class="info-div">
                                    </div>
                                    <div *ngIf="ld.rejected_date" class="info-div">
                                    </div>
                                    <div *ngIf="ld.approved_date" class="info-div">
                                    </div>
                                    <div *ngIf="ld.canceled_date" class="info-div">
                                    </div>
                                    <div *ngIf="ld.completed_date" class="info-div">
                                    </div>
                                    <div *ngIf="ld.confirm_date" class="info-div">
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="h30"></div>
                            <legend>{{'List Product'|trans}}</legend>

                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th class="text-center"></th>
                                    <th class="text-center">{{ 'Code' | trans }}</th>
                                    <th class="text-center">{{ 'Name' | trans }}</th>
                                    <th class="text-center">{{ 'Image' | trans }}</th>
                                    <th class="text-center col-md-1">{{ 'Customer Note' | trans }}</th>
                                    <th class="text-center col-md-1">{{ 'Sale Note' | trans }}</th>
                                    <th class="text-center">{{ 'Grade' | trans }}</th>
                                    <th class="text-center col-md-1">{{ 'Attributes' | trans }}</th>
                                    <th class="text-center">{{ 'Ordered UOM' | trans }}</th>
                                    <th class="text-center">{{ 'Ordered Quantity' | trans }}</th>
                                    <th class="text-center">{{ 'Sales Quantity' | trans }}</th>
                                    <th class="text-center">{{ 'Delivered Quantity' | trans }}</th>
                                    <th class="text-center">{{ 'Remaining Quantity' | trans }}</th>
                                    <th class="text-center">{{'Status' | trans}}</th>
                                    <th class="text-center">{{'Quantity Stock' | trans}}</th>
                                    <th class="text-center col-md-1">{{'Actions'|trans}}</th>
                                </tr>
                                </thead>
                                <tbody *ngIf="ld">
                                <tr *ngIf="ld.products.length === 0">
                                    <td colspan="16" class="text-center">{{'No data result'|trans}}</td>
                                </tr>
                                </tbody>
                                <tbody *ngIf="pivot_item">
                                <tr *ngFor="let item of pivot_item; let i = index">
                                    <td>{{ i + 1 }}</td>
                                    <td>{{item.product.code}}</td>
                                    <td>{{item.product.display_name}}</td>
                                    <td><img src="{{app.constant.FILE_UPLOAD_IMAGE}}{{item.product.image}}"
                                             width="75px" height="75px"></td>
                                    <td><textarea disabled cols="20" rows="5" [value]="item.user_note"  style="width: 100px;"></textarea>
                                    </td>
                                    <td *ngIf="item"><textarea class="sale_note{{item.id}} sale_note-disabled"
                                                               (input)="setData(item.id, item.product_id, 'amount', item.code , item.user_note,'sale_note')"
                                                               cols="20" rows="5" [value]="item.sale_note"
                                                               style="width: 100px;"></textarea>
                                    </td>
                                    <td>{{item.grade?item.grade.display_name:''}}</td>
                                    <td class="text-center">
                                        <div *ngFor="let attr of item.product_attr">
                                            <span *ngIf="attr.type === app.constant.Attributes_Type_String">{{attr.name + ':'}}<input style="width: 180px" disabled value="{{attr.attribute_label}}" class="product_attr{{attr.id}}"></span>
                                            <span *ngIf="attr.type === app.constant.Attributes_Type_Number">{{attr.name + ':'}}<input style="width: 180px" disabled value="{{attr.attribute_label}}" class="product_attr{{attr.id}}" ></span>
                                            <span *ngIf="attr.type === app.constant.Attributes_Type_List">{{attr.name + ':'}}
                                                        <select disabled style="width: 180px"  class="input-sm form-control attr " *ngIf="attr.listAttribute">
                                                             <option *ngFor="let j of attr.listAttribute|list" [value]="j.key" [selected]="j.key == attr.attribute_label" >
                                                                 {{j.value}}
                                                             </option>
                                                        </select>
                                                    </span>
                                        </div>
                                    </td>
                                    <td class="text-center">{{item.uom?item.uom.display_name:''}}</td>
                                    <td class="text-center">
                                        <input value="{{item.order_quantity}}" style="width: 50px" id="amount" class="amount{{item.id}} text-center amount-disabled quantity_{{i}} check_amount" disabled autocomplete="off"
                                               (input)="setData(item.id, item.product_id, 'amount', item.code , item.user_note,'sale_note')"
                                               type="text">
                                    </td>
                                    <td class="text-center">{{item.sale_quantity | number:'1.0-2'}}</td>
                                    <td class="text-center">{{item.delivery_quantity | number:'1.0-2'}}</td>
                                    <td class="text-center">{{item.remaining_quantity | number:'1.0-2'}}</td>
                                    <td>
                                        <span class="accept{{i}} accept"  *ngIf="item.status  == this.app.constant.Accept_ITEM_ORDER" style="color: green"> {{ 'Accept'|trans }} </span>
                                        <span class="reject{{i}}" *ngIf="item.status == this.app.constant.REJECT_ITEM_ORDER" style="color: red"> {{ 'Reject' | trans }} </span>
                                        <span class="reject-text{{i}} reject"></span>
                                    </td>
                                    <td>
                                        <p style="text-align: center; font-weight: bold" class="status_{{i}} check_stock"> {{ item.SoTonQD }} </p>
                                    </td>
                                    <td class="text-center">
                                        <div class="reject{{i}}" *ngIf="item.status  == this.app.constant.Accept_ITEM_ORDER && permissions[app.constant.PERMISSION_REJECT_ITEM_PRODUCT_ORDER]">
                                            <a (click)="rejectItemByAdmin(item.id, ld.status, i)" title="{{'Reject'|trans}}" id="rejectItemByAdmin" class=" btn btn-sm btn-default reject "><i class="fa fa-reply" aria-hidden="true"></i></a>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div *ngIf="ld" class="col-md-12">
                            <div class="h30"></div>
                            <legend>{{'Sale Note'|trans}}</legend>
                            <textarea id="admin_note"  formControlName="note" cols="183" rows="5"></textarea>

                            <div class="form-group action_box">
                                <div class="checkbox col-md-12">

                                    <a class="btn btn-default" [routerLink]='["/order"]' type="button">{{'Back'|trans}}</a>
                                    <button id="submit_button" class="btn btn-default send" type="submit" *ngIf=" permissions[app.constant.PERMISSION_UPDATE_ORDER]">{{'Submit'|trans}}</button>
                                    <button id="reject_button" (click)="ActionReject(app.constant.REJECTED_BY_SALES, ld.id)" class="btn btn-danger" type="button" *ngIf=" permissions[app.constant.PERMISSION_REJECT_ORDER]">{{'Reject'|trans}}</button>
                                    <button id="reviewing_button" (click)="ActionReviewing(app.constant.REVIEWING, ld.id)" class="btn btn-warning" type="button" *ngIf="permissions[app.constant.PERMISSION_REVIEW_ORDER]">{{'Reviewing'|trans}}</button>
                                    <button id="approved_button" (click)="ActionApproved(app.constant.SALES_APPROVED, ld.id)" class="btn btn-success" type="button" *ngIf="permissions[app.constant.PERMISSION_APPROVE_ORDER]">{{'Approved'|trans}}</button>
                                    <button id="detail_sale_order" class="btn btn-default" type="button" *ngIf="app.constant.SALES_ACCEPTED == ld.status || app.constant.DELIVERING == ld.status || app.constant.CLOSED == ld.status " (click)="directSo()"> {{'SO Detail '|trans}} <i class="fa fa-chevron-circle-right"></i></button>
                                    <button id="close_button" class="btn btn-danger" type="button" *ngIf="app.constant.DELIVERING == ld.status" (click)="closePO()" > {{'Close'|trans}}</button>

                                    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="false">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLabel"> Close Note  </h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <label class="col-md-2 control-label"> {{ 'Note' |trans }} <span class="text-danger"> * </span></label>
                                                        <div class="col-md-10">
                                                                <textarea type="text" placeholder="{{'Note'|trans}}" rows="5"
                                                                          class="form-control" (change)="checkRemainingQuantityNote($event);"
                                                                          autocomplete="off"></textarea>
                                                            <div class="note-error" style="color: red; padding-top: 10px"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                    <button type="button" class="btn btn-primary" (click)="SubmitNoteStatusClose()">Save changes</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

